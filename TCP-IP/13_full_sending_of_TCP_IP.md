# TCP/IP 방식에 따른 완전한 전송 과정

###### 2020.02.06

### **ARP 캐시 테이블이 비어 있고, DNS 서버가 8.8.8.8번일 경우의 웹 접속 과정**

---
>**라우터 맥주소 알아오기** (DNS 서버에 도메인 네임 질의를 하기 위해, DNS 서버에 요청을 보낼수 있는 준비)

1. 목적지 IP 주소에 해당하는 도메인 네임을 하드 디스크에서 검색한다. 윈도우라면 `C:\Windows\System32\drivers\etc\hosts`에서 검색한다.
2. 하드 디스크에서 해당 도메인 네임을 검색할 수 없으면 DNS 캐시 테이블에서 검색한다.
3. DNS 캐시 테이블에서도 해당 도메인 네임을 찾을 수 없다면, 내부의 DNS 서버IP 주소를 검색한 뒤 *로컬IP주소*와 *DNS서버IP주소*의 ***네트워크ID***를 자신의 *서브넷 마스크*를 이용해 비교한다. 출발지와 목적지의 네트워크 ID가 상이하기 때문에 DNS 서버로 가기 위해 ARP 테이블에서 라우터의 맥 주소를 검색한다.
4. ARP 캐시 테이블에서 라우터의 맥 주소를 검색할 수 없다면, 네트워크 계층에서는 1개의 ARP 헤더를 생성해 데이터 링크 계층으로 ARP 헤더를 넘긴다.
5. 데이터 링크 계층에서는 네트워크 계층으로부터 넘어온 ARP 헤더 앞에 헤더를 추가해 1개의 이더넷 프레임을 생성한 뒤 물리 계층으로 이더넷 프레임을 넘긴다.
6. 물리 계층에서는 데이터 링크 계층으로부터 넘어온 이더넷 프레임을 비트로 변환한 뒤 브로드캐스트 방식에 따라 ARP 요청을 LAN 영역 전체로 전송한다. 라우터는 자신의 맥 주소를 담아 송신자에게 유니캐스트 방식으로 ARP 응답을 전송한다.
7. 라우터로부터 ARP 응답이 오면 ARP 헤더에서 목적지 맥 주소를 추출해 ARP 캐시 테이블에 담는다.

---
>**라우터한테 말하기.. "도메인네임 서버한테 이 도메인 IP 좀 달라고 해줘!"** 

8. 응용 계층에서는 UDP 속성에 따라(DNS 서버에 보낼거니까) 질의정보를 담은 1개의 DNS 페이로드를 생성한 뒤 전송 계층으로 DNS 페이로드를 넘긴다.
9. 전송 계층에서는 응용 계층으로부터 넘어온 DNS 페이로드 앞에 UDP 헤더를 추가해, 1개의 UDP 데이터그램을 생성한 뒤 네트워크 계층으로 UDP 데이터그램을 넘긴다.
10.  네트워크 계층에서는 전송 계층으로부터 넘어온 UDP 데이터그램 앞에 IP 헤더를 추가해, 1개의 IP 패킷을 생성한 뒤 데이터링크 계층으로 넘긴다.
11.  데이터링크 계층에서는 네트워크 계층으로부터 넘어온 IP 패킷 앞에 헤더를 추가해 1개의 이더넷 프레임을 생성한 뒤 물리 계층으로 이더넷 프레임을 넘긴다.
12.  물리 계층에서는 데이터 링크 계층으로부터 넘어온 이더넷 프레임을 비트로 변환한 뒤 유니캐스트 방식에 따라 라우터로 해당 비트를 전송한다.
13.  라우터는 전송받은 비트를 일케저케 막 보고 다른 라우터와 적절한 프로토콜을 사용해 통신을 하여서 DNS 질의를 받아와 도로 PC로 전송한다.
14.  목적지 DNS서버의 응답을 받으면 해당 IP 주소를 DNS 캐시 테이블에 반영한다.

---
>**전송 전 3단계 연결 설정** (연결 설정조차 이렇게 복잡하다. 그래서 끊어지지 않게 설정하는 그런 헤더...? 를 사용하는 것이다.)

15. 응용계츤에서는 TCP 속성에 따라 HTTP 정보를 담은 1개의 HTTP 페이로드를 생성한 뒤 전송 계층으로 HTTP 페이로드를 넘긴다.
16. 전송계층에서는 응용 계층으로부터 넘어온 HTTP 페이로드를 자기 버퍼에 저장한다. (**버퍼링**)
17. 전송 계층에서는 *SYN* 플래그를 설정한 1개의 TCP 헤더를 생성해 네트워크 계층으로 TCP 헤더를 넘긴다.
18. 네트워크 계층에서는 전송 계층으로부터 넘어온 TCP 헤더 앞에 IP 헤더를 추가해, 1개의 패킷을 생성한 뒤 데이터 링크 계층으로 넘긴다.
19. 데이터 링크 계층에서는 ARP 캐시 테이블을 참조해 네트워크 계층으로부터 넘어온 IP 패킷 앞에 헤더를 추가해 1개의 이더넷 프레임을 생성한 뒤 물리 계층으로 이더넷 프레임을 넘긴다.
20. 물리 계층에서는 데이터 링크 계층으보부터 넘어온 이더넷 프레임을 비트로 변환한 뒤 유니캐스트 방식에 따라 라우터로 해당 비트를 전송한다.
21. 라우터는 라우터들을 거쳐 라우팅 통신을 하고 받은 SYN/ACK 플래그를 PC로 보낸다.
22. 목적지 웹 서버로부터의 SYN/ACK 플래그를 받은 전송계층은 ACK 플래그를 설정한 1개의 TCP 헤더를 생성해 네트워크 계층으로 TCP 헤더를 넘긴다.

---
>**드디어 사용자가 레알 원하는 요청읋 하고 응답을 받아온다.**

1.  목적지와 3단계 연결 과정을 마치면, 전송 계층에서는 자기 버퍼에 저장했던 HTTP 페이로드를 추출한 다음 HTTP 페이로드를 여러 개로 **단편화** 한다. 이제 조각난 HTTP 페이로드 각각에 TCP 헤더(*세그먼트 헤더*)를 추가해, 여러개의 TCP 세그먼트를 생성한 뒤, 네트워크 계층으로 TCP 세그먼트를 넘긴다.
2.  네트워크 계층에서는 전송 계층으로부터 넘어온 각각의 TCP 세그먼트 앞에 IP 헤더를 추가해 여러 개의 IP 패킷을 생성한 뒤 데이터 링크 계층으로 넘긴다.
3.  데이터 링크 계층에서는 ARP 캐시 테이블을 참조해 네트워크 계층으로부터 넘어온 각각의 IP 패킷 앞에 헤더를 추가해 여러 개의 이더넷 프레임을 생성한뒤 물리 계층으로 이더넷 프레임을 넘긴다. (PC -> 라우터 : 이더넷 프레임)
4.  물리 계층에서는 데이터 링크 계층으로부터 넘어온 이더넷 프레임을 비트로 변환한 뒤 유니캐스트 방식에 따라 라우터로 해당 비트를 전송한다.
5.  라우터는 비트 > 프레임 > 패킷 순으로 변환해 아이피르 알아내고 다시 패킷 > 프레임 > 비트로 변환해 다른 라우터와 통신한다. (라우터 -> 다른 라우터 : PPP 프레임)