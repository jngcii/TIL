# TCP/IP 방식의 네트워크 계층

###### 2020.02.06

- 네트워크 계층에서는 전송계층으로부터 넘어온 각 세그먼트 앞에 **IP주소**를 포함한 헤더를 추가하면서 두개의 **패킷**을 생성한다.


### I. IP헤더 (패킷헤더)

- 버전 항목 : IPv4면 4, IPv6면 6 이 들어간다.
- 헤더 길이 : IP 헤더의 크기 (일반적으로 20바이트)
- **ToS** : 해당 패킷의 전송 우선순위
- 전체 길이 : IP 헤더를 포함한 패킷 전체의 길이
- 그 외 (ID, IP플래그, 프래그먼트 오프셋) : MTU에 따른 패킷 분할 정보를 담는 항목
    >MTU : 각 프로토콜에서 정한 데이터 크기의 최대 범위
- 생존 시간 (TTL)
  - 라우팅 루프가 일어난 구간에서 패킷을 폐기하기 위한 용도로 사용
  - 해당 패킷이 통과할 수 있는 라우터 개수

<br />

### II. IP 주소

#### 1) **사설IP**
- LAN 전용 주소 (혹은 LAN 내부 주소)
- LAN 영역 내에서만 사용한다.
- 인터넷 사용자가 급증하면서, IP주소에 대한 수요도 급격히 증가했다.

#### 2) **공인IP**
- 전체 IP 중에 사설 IP 주소를 제외한 나머지 IP 주소

#### 3) **NAT**
- 사설IP주소는 LAN 영역에서 전용으로 사용할 수 있는 주소임에도 실제 인터넷에 접속할 수 있다.
- 출발지 *사설 IP주소*를 출발지 *공인 IP주소*로 바꿔주는 것
- 주로 라우터같은 장비에서 이용
  
#### 4) **PAT**
- NAT 기법에 포트 번호 주소를 연동해 사용하는 것
- 이론적으로 1개의 IP 주소에 65,536개의 사설 IP 주소를 연결할 수 있다.
- **65,536개의 IP주소가 필요한 LAN영역에서 공인 IP 주소 1개만으로도 충분히 구성이 가능하다.**
- 보통 NAT와 PAT를 구분하기보단 NAT로 총칭한다.
- 사설 IP 주소는 개인이 IPS 업체에서 공인 IP 주소를 할당받을 필요가 없이 IP 대역을 임의로 사용할 수 있기 때문에 공인 IP 고갈을 완화하며, 외부에서 접근할 수 없어 보안에 좋다.
- 사설 IP 주소를 사용하면 NAT기법을 통해 외부로 나갈 수는 있지만 **외부에서는 실제 내부 IP 주소를 사용하는 PC로 접근이 불가능하다.**

#### 5) **포트 포워딩**
- 그렇다면 공인 IP 61.72.193.54번을 사용하는 LAN 영역에서 192.168.10.3 번처럼 사설 IP 주소를 이용해 웹 서버를 구축했다면 외부에서 해당 웹 서버에 접근할 수 있는 방법은 ?
- 내 컴퓨터의 포트를 공유기의 포트에 연결한다!! 포트를 내보낸다! : **포트포워딩**

<br />

### III. ICMP

- 전송 작업을 화면에 출력하기 위한 용도로 등장한 프로토콜
- 화면 출력 메세지에 기반해 **오류 통보 기능**과 **질의 응답 기능**을 수행하기 위한 프로토콜
- 오류 통보 : 목적지 도달 불가, 발신진 억제, 시관 초과, 매개변수의 문제 등
- **질의 응답**
  - 목적지 호스트가 바로 옆자리라면 목적지 호스트가 동작하는 여부를 알기 쉽지만 지구 건너편에 있다면 직접 확인 불가
  - 이럴 경우 쓰레기값으로 이루어진 데이터를 생성해 ping 명령어로 전송한다.
  - 목적지 호스트가 동작중이라면 응답이 온다.
- FTH나 SSH, HTTP와 같은 서비스는 응용계층에서 페이로드를 생성하지만, ICMP 프로토콜은 네트워크 계층에서부터 페이로드를 생성한다. (무조건 5,972바이트 크기의 쓰레기값이 담긴 페이로드)
- 그리고 그 앞에 8바이트 크기의 타입, 코드, 오류검사 정보를 담은 ICMP 헤더가 붙는다.